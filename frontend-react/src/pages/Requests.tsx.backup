import React, { useState, useEffect, useMemo } from 'react';
import { requestsService } from '../services/requests';
import { authService } from '../services/auth';
import { useAuth } from '../context/AuthContext';
import type { Request, User, CreateRequestDto } from '../types';
import './Requests.css';
import './RequestModalCompact.css';
import './RequestModalUltraCompact.css';

const Requests: React.FC = () => {
    const [requests, setRequests] = useState<Request[]>([]);
    const [loading, setLoading] = useState(true);
    const [filter, setFilter] = useState<'all' | 'created' | 'assigned'>('all'); // Basic tab filter
    const [statusFilter, setStatusFilter] = useState<string>('');
    const [searchQuery, setSearchQuery] = useState('');
    const [showCreateModal, setShowCreateModal] = useState(false);
    const [selectedRequest, setSelectedRequest] = useState<Request | null>(null); // For answering
    const [viewingRequest, setViewingRequest] = useState<Request | null>(null); // For viewing details
    const [users, setUsers] = useState<User[]>([]);
    const { currentUser } = useAuth();

    // Sorting
    const [sortColumn, setSortColumn] = useState('');
    const [sortDirection, setSortDirection] = useState<'asc' | 'desc'>('asc');

    const [formData, setFormData] = useState<CreateRequestDto>({
        title: '',
        description: '',
        priority: '–°—Ä–µ–¥–Ω–∏–π',
        createdByUserId: currentUser?.id || 0,
        assignedToUserId: 0,
    });

    useEffect(() => {
        loadRequests();
    }, [filter]); // Reload when main tab changes (created/assigned/all) - logic inside loadRequests handles this

    useEffect(() => {
        loadUsers();
    }, []);

    useEffect(() => {
        if (currentUser?.id) {
            setFormData(prev => ({
                ...prev,
                createdByUserId: currentUser.id
            }));
        }
    }, [currentUser]);

    const loadRequests = async () => {
        try {
            setLoading(true);
            let data: Request[];

            if (filter === 'created') {
                data = await requestsService.getAll({ createdBy: currentUser?.id });
            } else if (filter === 'assigned') {
                data = await requestsService.getAll({ assignedTo: currentUser?.id });
            } else {
                data = await requestsService.getAll();
            }
            setRequests(data);
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞—è–≤–æ–∫:', error);
        } finally {
            setLoading(false);
        }
    };

    const loadUsers = async () => {
        try {
            const data = await authService.getUsers();
            setUsers(data);
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', error);
        }
    };

    // Filter and Sort Logic
    const filteredRequests = useMemo(() => {
        let result = requests.filter(req => {
            const matchSearch = !searchQuery ||
                req.title.toLowerCase().includes(searchQuery.toLowerCase()) ||
                req.id.toString().includes(searchQuery);

            const matchStatus = !statusFilter || req.status === statusFilter;

            return matchSearch && matchStatus;
        });

        if (sortColumn) {
            result.sort((a, b) => {
                let valA: any = a[sortColumn as keyof Request] || '';
                let valB: any = b[sortColumn as keyof Request] || '';

                // Handle nested objects for sorting if needed (e.g. user names)
                if (sortColumn === 'createdByUser') valA = a.createdByUser?.name || '';
                if (sortColumn === 'createdByUser') valB = b.createdByUser?.name || '';
                if (sortColumn === 'assignedToUser') valA = a.assignedToUser?.name || '';
                if (sortColumn === 'assignedToUser') valB = b.assignedToUser?.name || '';

                if (sortColumn === 'createdAt' || sortColumn === 'updatedAt') {
                    valA = new Date(valA || 0).getTime();
                    valB = new Date(valB || 0).getTime();
                }

                if (valA < valB) return sortDirection === 'asc' ? -1 : 1;
                if (valA > valB) return sortDirection === 'asc' ? 1 : -1;
                return 0;
            });
        } else {
            // Default sort by ID desc
            result.sort((a, b) => b.id - a.id);
        }

        return result;
    }, [requests, searchQuery, statusFilter, sortColumn, sortDirection]);

    const handleSort = (column: string) => {
        if (sortColumn === column) {
            setSortDirection(prev => prev === 'asc' ? 'desc' : 'asc');
        } else {
            setSortColumn(column);
            setSortDirection('asc');
        }
    };

    const handleCreateRequest = async (e: React.FormEvent) => {
        e.preventDefault();
        if (!currentUser || !currentUser.id) {
            alert('–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
            return;
        }

        const requestData = {
            ...formData,
            createdByUserId: currentUser.id
        };

        try {
            await requestsService.create(requestData);
            setShowCreateModal(false);
            setFormData({
                title: '',
                description: '',
                priority: '–°—Ä–µ–¥–Ω–∏–π',
                createdByUserId: currentUser?.id || 0,
                assignedToUserId: 0,
            });
            loadRequests();
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞—è–≤–∫–∏:', error);
        }
    };

    const handleTakeInWork = async (requestId: number) => {
        try {
            await requestsService.takeInWork(requestId, currentUser?.id || 0);
            loadRequests();
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤–∑—è—Ç–∏–∏ –≤ —Ä–∞–±–æ—Ç—É:', error);
        }
    };

    const handleAnswer = async (requestId: number, response: string) => {
        try {
            await requestsService.answer(requestId, currentUser?.id || 0, response);
            loadRequests();
            setSelectedRequest(null);
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–≤–µ—Ç–µ:', error);
        }
    };

    const handleClose = async (requestId: number) => {
        try {
            await requestsService.close(requestId, currentUser?.id || 0);
            loadRequests();
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏:', error);
        }
    };

    const handleReject = async (requestId: number, reason: string) => {
        try {
            await requestsService.reject(requestId, currentUser?.id || 0, reason);
            loadRequests();
            setSelectedRequest(null);
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–∏:', error);
        }
    };

    const getStatusClass = (status: string): string => {
        const statusMap: Record<string, string> = {
            '–ù–æ–≤–∞—è': 'status-new',
            '–í —Ä–∞–±–æ—Ç–µ': 'status-in-progress',
            '–û—Ç–≤–µ—á–µ–Ω–∞': 'status-answered',
            '–ó–∞–∫—Ä—ã—Ç–∞': 'status-closed',
            '–û—Ç–∫–ª–æ–Ω–µ–Ω–∞': 'status-rejected',
        };
        return statusMap[status] || '';
    };

    const getPriorityClass = (priority: string): string => {
        const priorityMap: Record<string, string> = {
            '–ù–∏–∑–∫–∏–π': 'priority-low',
            '–°—Ä–µ–¥–Ω–∏–π': 'priority-medium',
            '–í—ã—Å–æ–∫–∏–π': 'priority-high',
            '–°—Ä–æ—á–Ω—ã–π': 'priority-urgent',
        };
        return priorityMap[priority] || '';
    };

    const getRoleColor = (role?: string): string => {
        const colors: Record<string, string> = {
            '–ú–ü': '#42A5F5',
            '–ú–†–∏–ó': '#66BB6A',
            '–ë–ê': '#FFA726',
            '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä': '#9C27B0'
        };
        return colors[role || ''] || '#999';
    };

    // Stats
    const totalRequests = requests.length;
    const newRequestsCount = requests.filter(r => r.status === '–ù–æ–≤–∞—è').length;
    const inProgressCount = requests.filter(r => r.status === '–í —Ä–∞–±–æ—Ç–µ').length;

    // Quick Initials Helper
    const getInitials = (name: string) => {
        if (!name) return '?';
        return name.charAt(0);
    };

    if (loading) return <div className="requests-page"><div className="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div></div>;

    return (
        <div className="requests-page">
            {/* Unified Controls Row - Matches Tasks Page Style */}
            <div className="unified-controls-row">
                {/* Left: Quick Stats */}
                <div className="quick-stats-inline">
                    <div className="stat-card-mini">
                        <span className="stat-label-mini">–í—Å–µ–≥–æ</span>
                        <span className="stat-value-mini">{totalRequests}</span>
                    </div>
                    <div className="stat-card-mini">
                        <span className="stat-label-mini">–ù–æ–≤—ã–µ</span>
                        <span className="stat-value-mini" style={{ color: '#0369a1' }}>{newRequestsCount}</span>
                    </div>
                    <div className="stat-card-mini">
                        <span className="stat-label-mini">–í —Ä–∞–±–æ—Ç–µ</span>
                        <span className="stat-value-mini" style={{ color: '#a16207' }}>{inProgressCount}</span>
                    </div>
                </div>

                {/* Right: Controls & Filters */}
                <div className="controls-right-group">
                    {/* Tab Filter (All / My / Assigned) */}
                    <select
                        className="compact-select"
                        value={filter}
                        onChange={(e) => setFilter(e.target.value as any)}
                    >
                        <option value="all">–í—Å–µ –∑–∞—è–≤–∫–∏</option>
                        <option value="created">–ú–æ–∏ –∑–∞—è–≤–∫–∏</option>
                        <option value="assigned">–ù–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–µ –º–Ω–µ</option>
                    </select>

                    <select
                        className="compact-select"
                        value={statusFilter}
                        onChange={(e) => setStatusFilter(e.target.value)}
                    >
                        <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                        <option value="–ù–æ–≤–∞—è">–ù–æ–≤–∞—è</option>
                        <option value="–í —Ä–∞–±–æ—Ç–µ">–í —Ä–∞–±–æ—Ç–µ</option>
                        <option value="–û—Ç–≤–µ—á–µ–Ω–∞">–û—Ç–≤–µ—á–µ–Ω–∞</option>
                        <option value="–ó–∞–∫—Ä—ã—Ç–∞">–ó–∞–∫—Ä—ã—Ç–∞</option>
                        <option value="–û—Ç–∫–ª–æ–Ω–µ–Ω–∞">–û—Ç–∫–ª–æ–Ω–µ–Ω–∞</option>
                    </select>

                    <div className="search-wrapper-compact">
                        <span className="search-icon">üîç</span>
                        <input
                            type="text"
                            className="search-input-compact"
                            placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∏–ª–∏ ID"
                            value={searchQuery}
                            onChange={(e) => setSearchQuery(e.target.value)}
                        />
                    </div>

                    <button className="btn-create-compact" onClick={() => setShowCreateModal(true)}>
                        <span>+</span> –°–æ–∑–¥–∞—Ç—å
                    </button>
                </div>
            </div>

            {/* Table View */}
            <div className="requests-table-container">
                <table className="requests-table">
                    <thead>
                        <tr>
                            <th style={{ width: '5%' }} onClick={() => handleSort('id')}>ID {sortColumn === 'id' && (sortDirection === 'asc' ? '‚Üë' : '‚Üì')}</th>
                            <th style={{ width: '25%' }} onClick={() => handleSort('title')}>–ù–∞–∑–≤–∞–Ω–∏–µ {sortColumn === 'title' && (sortDirection === 'asc' ? '‚Üë' : '‚Üì')}</th>
                            <th style={{ width: '10%' }} onClick={() => handleSort('status')}>–°—Ç–∞—Ç—É—Å {sortColumn === 'status' && (sortDirection === 'asc' ? '‚Üë' : '‚Üì')}</th>
                            <th style={{ width: '10%' }} onClick={() => handleSort('priority')}>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç {sortColumn === 'priority' && (sortDirection === 'asc' ? '‚Üë' : '‚Üì')}</th>
                            <th style={{ width: '15%' }} onClick={() => handleSort('createdByUser')}>–ò–Ω–∏—Ü–∏–∞—Ç–æ—Ä {sortColumn === 'createdByUser' && (sortDirection === 'asc' ? '‚Üë' : '‚Üì')}</th>
                            <th style={{ width: '15%' }} onClick={() => handleSort('assignedToUser')}>–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π {sortColumn === 'assignedToUser' && (sortDirection === 'asc' ? '‚Üë' : '‚Üì')}</th>
                            <th style={{ width: '10%' }} onClick={() => handleSort('createdAt')}>–°–æ–∑–¥–∞–Ω–æ {sortColumn === 'createdAt' && (sortDirection === 'asc' ? '‚Üë' : '‚Üì')}</th>
                            <th style={{ width: '10%' }} onClick={() => handleSort('updatedAt')}>–û–±–Ω–æ–≤–ª–µ–Ω–æ {sortColumn === 'updatedAt' && (sortDirection === 'asc' ? '‚Üë' : '‚Üì')}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {filteredRequests.length === 0 ? (
                            <tr>
                                <td colSpan={8}>
                                    <div className="empty-state">–ù–µ—Ç –∑–∞—è–≤–æ–∫</div>
                                </td>
                            </tr>
                        ) : (
                            filteredRequests.map(request => (
                                <tr key={request.id} className="clickable-row" onClick={() => setViewingRequest(request)}>
                                    <td><span className="request-id-badge">#{request.id}</span></td>
                                    <td>
                                        <span className="request-title-cell" title={request.title}>{request.title}</span>
                                    </td>
                                    <td>
                                        <span className={`status-badge ${getStatusClass(request.status)}`}>
                                            {request.status}
                                        </span>
                                    </td>
                                    <td>
                                        <span className={`priority-badge ${getPriorityClass(request.priority)}`}>
                                            {request.priority}
                                        </span>
                                    </td>
                                    <td>
                                        {request.createdByUser ? (
                                            <div className="user-cell-flex">
                                                <div
                                                    className="user-avatar-sm"
                                                    style={{ background: getRoleColor(request.createdByUser.role) }}
                                                >
                                                    {getInitials(request.createdByUser.name)}
                                                </div>
                                                <span className="user-name-text">{request.createdByUser.name}</span>
                                            </div>
                                        ) : <span className="text-muted">–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ</span>}
                                    </td>
                                    <td>
                                        {request.assignedToUser ? (
                                            <div className="user-cell-flex">
                                                <div
                                                    className="user-avatar-sm"
                                                    style={{ background: getRoleColor(request.assignedToUser.role) }}
                                                >
                                                    {getInitials(request.assignedToUser.name)}
                                                </div>
                                                <span className="user-name-text">{request.assignedToUser.name}</span>
                                            </div>
                                        ) : <span className="text-muted" style={{ fontSize: '12px' }}>–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω</span>}
                                    </td>
                                    <td>
                                        {new Date(request.createdAt).toLocaleDateString('ru-RU')}
                                    </td>
                                    <td>
                                        {new Date(request.updatedAt).toLocaleDateString('ru-RU')}
                                    </td>
                                </tr>
                            ))
                        )}
                    </tbody>
                </table>
            </div>

            {/* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞—è–≤–∫–∏ */}
            {showCreateModal && (
                <div className="modal-overlay" onClick={() => setShowCreateModal(false)}>
                    <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                        <h2>–°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É</h2>
                        <form onSubmit={handleCreateRequest}>
                            <div className="form-group">
                                <label>–ù–∞–∑–≤–∞–Ω–∏–µ *</label>
                                <input
                                    type="text"
                                    value={formData.title}
                                    onChange={(e) => setFormData({ ...formData, title: e.target.value })}
                                    required
                                />
                            </div>

                            <div className="form-group">
                                <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
                                <textarea
                                    value={formData.description}
                                    onChange={(e) => setFormData({ ...formData, description: e.target.value })}
                                    rows={4}
                                />
                            </div>

                            <div className="form-group">
                                <label>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</label>
                                <select
                                    value={formData.priority}
                                    onChange={(e) => setFormData({ ...formData, priority: e.target.value as any })}
                                >
                                    <option value="–ù–∏–∑–∫–∏–π">–ù–∏–∑–∫–∏–π</option>
                                    <option value="–°—Ä–µ–¥–Ω–∏–π">–°—Ä–µ–¥–Ω–∏–π</option>
                                    <option value="–í—ã—Å–æ–∫–∏–π">–í—ã—Å–æ–∫–∏–π</option>
                                    <option value="–°—Ä–æ—á–Ω—ã–π">–°—Ä–æ—á–Ω—ã–π</option>
                                </select>
                            </div>

                            <div className="form-group">
                                <label>–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π *</label>
                                <select
                                    value={formData.assignedToUserId || ''}
                                    onChange={(e) => setFormData({ ...formData, assignedToUserId: parseInt(e.target.value) })}
                                    required
                                >
                                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</option>
                                    {users
                                        .filter(user => user.id !== currentUser?.id)
                                        .map(user => (
                                            <option key={user.id} value={user.id}>
                                                {user.name} ({user.role})
                                            </option>
                                        ))
                                    }
                                </select>
                            </div>

                            <div className="modal-actions">
                                <button type="button" className="btn-cancel" onClick={() => setShowCreateModal(false)}>
                                    –û—Ç–º–µ–Ω–∞
                                </button>
                                <button type="submit" className="btn-submit">
                                    –°–æ–∑–¥–∞—Ç—å
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            )}

            {/* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –∑–∞—è–≤–∫—É */}
            {selectedRequest && (
                <div className="modal-overlay" onClick={() => setSelectedRequest(null)}>
                    <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                        <h2>–û—Ç–≤–µ—Ç –Ω–∞ –∑–∞—è–≤–∫—É</h2>
                        <p><strong>{selectedRequest.title}</strong></p>
                        <form onSubmit={(e) => {
                            e.preventDefault();
                            const response = (e.target as any).response.value;
                            if (response) {
                                handleAnswer(selectedRequest.id, response);
                            }
                        }}>
                            <div className="form-group">
                                <label>–í–∞—à –æ—Ç–≤–µ—Ç *</label>
                                <textarea
                                    name="response"
                                    rows={4}
                                    required
                                />
                            </div>

                            <div className="modal-actions">
                                <button type="button" className="btn-cancel" onClick={() => setSelectedRequest(null)}>
                                    –û—Ç–º–µ–Ω–∞
                                </button>
                                <button type="submit" className="btn-submit">
                                    –û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç
                                </button>
                                <button
                                    type="button"
                                    className="btn-reject"
                                    onClick={() => {
                                        const reason = prompt('–£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è:');
                                        if (reason) {
                                            handleReject(selectedRequest.id, reason);
                                        }
                                    }}
                                >
                                    –û—Ç–∫–ª–æ–Ω–∏—Ç—å
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            )}

            {/* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–µ—Ç–∞–ª–µ–π –∑–∞—è–≤–∫–∏ */}
            {viewingRequest && (
                <div className="modal-overlay" onClick={() => setViewingRequest(null)}>
                    <div className="request-detail-modal modal-container-improved" style={{ maxWidth: '750px' }} onClick={(e) => e.stopPropagation()}>
                        {/* Header - Compact with badges */}
                        <div className="request-modal-header">
                            <div className="header-top">
                                <div className="request-header-content">
                                    <div className="request-header-icon">üìã</div>
                                    <div className="request-header-text">
                                        <h2 className="request-header-title">{viewingRequest.title}</h2>
                                        <div className="request-header-meta">
                                            <span className="request-id-chip">#{viewingRequest.id}</span>
                                            <div className={`status-badge-mini status-${viewingRequest.status?.toLowerCase().replace(/\s+/g, '-')}`}>
                                                {viewingRequest.status}
                                            </div>
                                            <div className={`priority-badge-mini priority-${viewingRequest.priority?.toLowerCase()}`}>
                                                {viewingRequest.priority}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <button className="btn-close-improved" onClick={() => setViewingRequest(null)}>√ó</button>
                            </div>
                        </div>

                        {/* Body - Ultra Compact */}
                        <div className="request-modal-body">
                            {/* –û–ø–∏—Å–∞–Ω–∏–µ */}
                            {viewingRequest.description && (
                                <div className="request-section-compact">
                                    <div className="section-label">üìù –û–ø–∏—Å–∞–Ω–∏–µ</div>
                                    <div className="section-value">{viewingRequest.description}</div>
                                </div>
                            )}

                            {/* –£—á–∞—Å—Ç–Ω–∏–∫–∏ - –í –û–î–ù–£ –°–¢–†–û–ö–£ */}
                            <div className="participants-row">
                                <div className="participant-compact">
                                    <span className="participant-icon">üë§</span>
                                    <div className="participant-data">
                                        <span className="participant-label">–ò–Ω–∏—Ü–∏–∞—Ç–æ—Ä</span>
                                        <span className="participant-text">
                                            {viewingRequest.createdByUser?.name || `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å #${viewingRequest.createdByUserId}`}
                                            {viewingRequest.createdByUser?.role && <span className="role-chip">{viewingRequest.createdByUser.role}</span>}
                                        </span>
                                    </div>
                                </div>

                                <div className="participant-compact">
                                    <span className="participant-icon">üéØ</span>
                                    <div className="participant-data">
                                        <span className="participant-label">–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π</span>
                                        <span className="participant-text">
                                            {viewingRequest.assignedToUser?.name || `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å #${viewingRequest.assignedToUserId}`}
                                            {viewingRequest.assignedToUser?.role && <span className="role-chip">{viewingRequest.assignedToUser.role}</span>}
                                        </span>
                                    </div>
                                </div>
                            </div>

                            {/* –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ - 4 –ö–û–õ–û–ù–ö–ò */}
                            <div className="metadata-row">
                                <div className="meta-item">
                                    <span className="meta-icon">üìÖ</span>
                                    <div className="meta-data">
                                        <span className="meta-label">–°–æ–∑–¥–∞–Ω–æ</span>
                                        <span className="meta-value">
                                            {new Date(viewingRequest.createdAt).toLocaleDateString('ru-RU', {
                                                day: '2-digit',
                                                month: 'short',
                                                hour: '2-digit',
                                                minute: '2-digit'
                                            })}
                                        </span>
                                    </div>
                                </div>

                                <div className="meta-item">
                                    <span className="meta-icon">üîÑ</span>
                                    <div className="meta-data">
                                        <span className="meta-label">–û–±–Ω–æ–≤–ª–µ–Ω–æ</span>
                                        <span className="meta-value">
                                            {new Date(viewingRequest.updatedAt).toLocaleDateString('ru-RU', {
                                                day: '2-digit',
                                                month: 'short',
                                                hour: '2-digit',
                                                minute: '2-digit'
                                            })}
                                        </span>
                                    </div>
                                </div>

                                {viewingRequest.projectId && (
                                    <div
                                        className="meta-item meta-link"
                                        onClick={() => window.location.href = `/projects/${viewingRequest.projectId}`}
                                    >
                                        <span className="meta-icon">üìÅ</span>
                                        <div className="meta-data">
                                            <span className="meta-label">–ü—Ä–æ–µ–∫—Ç</span>
                                            <span className="meta-value link-value">#{viewingRequest.projectId} ‚Üí</span>
                                        </div>
                                    </div>
                                )}

                                {viewingRequest.taskId && (
                                    <div
                                        className="meta-item meta-link"
                                        onClick={() => window.location.href = `/projects/${viewingRequest.projectId}`}
                                    >
                                        <span className="meta-icon">‚úì</span>
                                        <div className="meta-data">
                                            <span className="meta-label">–ó–∞–¥–∞—á–∞</span>
                                            <span className="meta-value link-value">#{viewingRequest.taskId} ‚Üí</span>
                                        </div>
                                    </div>
                                )}
                            </div>                                                #{viewingRequest.taskId} ‚Üí
                        </div>
                    </div>
                </div>
            )}
        </div>

                            {/* –û—Ç–≤–µ—Ç –Ω–∞ –∑–∞—è–≤–∫—É */ }
    {
        viewingRequest.response ? (
            <div className="request-response-section">
                <div className="response-header">
                    <span className="response-icon">üí¨</span>
                    <span className="response-title">–û—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω</span>
                </div>
                <div className="response-content">
                    {viewingRequest.response}
                </div>
            </div>
        ) : viewingRequest.status === '–ù–æ–≤–∞—è' ? (
            <div className="request-waiting-section">
                <div className="waiting-icon-wrapper">
                    <span className="waiting-icon">‚è≥</span>
                </div>
                <div className="waiting-text">–û–∂–∏–¥–∞–µ—Ç—Å—è –æ—Ç–≤–µ—Ç –æ—Ç –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ</div>
            </div>
        ) : null
    }
                        </div >

    {/* Footer */ }
    < div className = "request-modal-footer" >
    {
        viewingRequest.status === '–ù–æ–≤–∞—è' && viewingRequest.assignedToUserId === currentUser?.id && (
            <button
                className="btn-action primary"
                onClick={() => {
                    setViewingRequest(null);
                    handleTakeInWork(viewingRequest.id);
                }}
                style={{ marginRight: 'auto' }}
            >
                –í–∑—è—Ç—å –≤ —Ä–∞–±–æ—Ç—É
            </button>
        )
    }
{
    (viewingRequest.status === '–í —Ä–∞–±–æ—Ç–µ' || viewingRequest.status === '–ù–æ–≤–∞—è') &&
        viewingRequest.assignedToUserId === currentUser?.id && (
            <button
                className="btn-action primary"
                onClick={() => {
                    setViewingRequest(null);
                    setSelectedRequest(viewingRequest);
                }}
                style={{ marginRight: 'auto' }}
            >
                –û—Ç–≤–µ—Ç–∏—Ç—å
            </button>
        )
}
<button
    className="btn-secondary request-close-btn"
    onClick={() => setViewingRequest(null)}
>
    –ó–∞–∫—Ä—ã—Ç—å
</button>
                        </div >
                    </div >
                </div >
            )}
        </div >
    );
};

export default Requests;
