# Конструктор задач для администратора
## Техническое предложение и варианты реализации

---

## 📋 Анализ текущей системы

### Существующая структура задач
**Backend:** `ProjectTask` содержит **40+ полей**:
- Базовые: Name, TaskType, Status, ResponsibleUserId
- Даты: NormativeDeadline, PlannedStartDate, ActualDate
- Специфичные: AlcoholLicenseEligibility, TboDocsLink, EquipmentCostNoVat и т.д.
- Зависимости: DependsOn (JSON строка)

### Проблема
Все поля жестко заданы в модели. Невозможно:
- Добавить новое поле без изменения БД
- Сделать поле обязательным/необязательным динамически
- Создать пользовательские типы полей

---

## 🎯 Варианты реализации

## Вариант 1: Template-based (Рекомендуемый) ⭐
### Концепция: Шаблоны задач с метаданными о полях

### Архитектура

```
TaskTemplate (шаблон задачи)
├── Basic Info (основная информация)
├── FieldDefinitions (определения полей)
│   ├── Field 1: Name (обязательное, text)
│   ├── Field 2: Budget (необязательное, number)
│   └── Field 3: Documents (обязательное, file_upload)
└── ValidationRules (правила валидации)
```

### Backend структура

**Новые модели:**

```go
// backend-go/models/task_template.go
type TaskTemplate struct {
    ID          uint                `json:"id"`
    Code        string              `json:"code"`          // Уникальный код шаблона
    Name        string              `json:"name"`          // Название шаблона
    Description string              `json:"description"`   // Описание
    Category    string              `json:"category"`      // Категория (Аудит, Бюджет, СМР и т.д.)
    IsActive    bool                `json:"isActive"`      // Активен ли шаблон
    Fields      []TaskFieldTemplate `json:"fields"`        // Определения полей
    CreatedAt   time.Time           `json:"createdAt"`
    UpdatedAt   time.Time           `json:"updatedAt"`
}

type TaskFieldTemplate struct {
    ID              uint                `json:"id"`
    TemplateID      uint                `json:"templateId"`
    FieldKey        string              `json:"fieldKey"`        // Ключ поля (camelCase)
    FieldLabel      string              `json:"fieldLabel"`      // Отображаемое название
    FieldType       string              `json:"fieldType"`       // text, number, date, select, file_upload, etc.
    IsRequired      bool                `json:"isRequired"`      // Обязательное ли поле
    IsVisible       bool                `json:"isVisible"`       // Видно ли поле в форме
    DefaultValue    *string             `json:"defaultValue"`    // Значение по умолчанию
    ValidationRules *string             `json:"validationRules"` // JSON с правилами валидации
    Options         *string             `json:"options"`         // JSON с опциями (для select)
    Order           int                 `json:"order"`           // Порядок отображения
    Section         string              `json:"section"`         // Секция (Основное, Бюджет, Документы)
}

// Обновленная модель задачи с динамическими полями
type ProjectTask struct {
    // ... существующие поля ...
    
    TemplateID      *uint               `json:"templateId"`      // Ссылка на шаблон
    CustomFields    *string             `json:"customFields"`    // JSON с кастомными полями
}

// Структура кастомных полей
type TaskCustomFields map[string]interface{} // {"budgetAmount": 150000, "contractNumber": "DOC-123"}
```

### Frontend структура

**Новая страница:** `frontend-react/src/pages/TaskTemplateBuilder.tsx`

```typescript
interface TaskTemplate {
    id?: number;
    code: string;
    name: string;
    description: string;
    category: string;
    isActive: boolean;
    fields: TaskFieldTemplate[];
}

interface TaskFieldTemplate {
    id?: number;
    fieldKey: string;
    fieldLabel: string;
    fieldType: FieldType;
    isRequired: boolean;
    isVisible: boolean;
    defaultValue?: string;
    validationRules?: ValidationRule[];
    options?: SelectOption[];
    order: number;
    section: string;
}

type FieldType = 
    | 'text' 
    | 'textarea'
    | 'number' 
    | 'date' 
    | 'datetime'
    | 'select' 
    | 'multiselect'
    | 'checkbox'
    | 'file_upload'
    | 'user_select'
    | 'currency';

interface ValidationRule {
    type: 'min' | 'max' | 'regex' | 'required' | 'email' | 'url';
    value: any;
    message: string;
}
```

### UI/UX Конструктора

**Левая панель** - Библиотека компонентов:
```
┌─────────────────────────┐
│ Библиотека полей        │
├─────────────────────────┤
│ 📝 Текстовое поле       │
│ 🔢 Числовое поле        │
│ 📅 Дата                 │
│ ⏰ Дата и время         │
│ 🔽 Выпадающий список    │
│ ☑️  Чекбокс             │
│ 📎 Загрузка файлов      │
│ 👤 Выбор пользователя   │
│ 💰 Денежное поле        │
└─────────────────────────┘
```

**Центральная панель** - Холст конструктора (Drag & Drop):
```
┌─────────────────────────────────────┐
│ Секция: Основная информация         │
├─────────────────────────────────────┤
│ [📝 Название задачи] *обязательное  │
│ [🔽 Тип задачи] *обязательное       │
│ [👤 Ответственный] *обязательное    │
├─────────────────────────────────────┤
│ Секция: Сроки                       │
├─────────────────────────────────────┤
│ [📅 Нормативный срок] *обязательное │
│ [📅 Плановая дата старта]           │
├─────────────────────────────────────┤
│ Секция: Бюджет                      │
├─────────────────────────────────────┤
│ [💰 Бюджет без НДС]                 │
│ [💰 Стоимость оборудования]         │
├─────────────────────────────────────┤
│ [+ Добавить секцию]                 │
└─────────────────────────────────────┘
```

**Правая панель** - Свойства выбранного поля:
```
┌─────────────────────────┐
│ Свойства поля           │
├─────────────────────────┤
│ Название: [_________]   │
│ Ключ: [budgetAmount]    │
│ Тип: [💰 Денежное ▼]   │
│                         │
│ ☑ Обязательное          │
│ ☑ Видимое               │
│ ☐ Только для чтения     │
│                         │
│ Секция: [Бюджет ▼]      │
│                         │
│ Валидация:              │
│ • Min: [1000]           │
│ • Max: [10000000]       │
│                         │
│ Значение по умолчанию:  │
│ [0]                     │
│                         │
│ [🗑️ Удалить]  [✓ Применить]│
└─────────────────────────┘
```

### Процесс работы

1. **Создание шаблона**
   - Admin переходит в "Администрирование" → "Конструктор задач"
   - Нажимает "Создать новый шаблон"
   - Задает название, код, категорию

2. **Добавление полей**
   - Drag & Drop полей из библиотеки
   - Настройка свойств каждого поля
   - Группировка в секции

3. **Настройка валидации**
   - Отметка обязательных полей
   - Установка min/max значений
   - Добавление регулярных выражений

4. **Сохранение и активация**
   - Предпросмотр шаблона
   - Сохранение в БД
   - Активация для использования

5. **Использование при создании задачи**
   - При создании задачи выбирается шаблон
   - Форма генерируется динамически на основе шаблона
   - Валидация происходит по правилам шаблона

### Преимущества ✅
- ✅ Гибкость: любые поля без изменения БД
- ✅ Переиспользование: один шаблон для многих задач
- ✅ Версионирование: можно делать версии шаблонов
- ✅ Интуитивный UI с Drag & Drop
- ✅ Визуальный предпросмотр

### Недостатки ❌
- ❌ Средняя сложность реализации
- ❌ Требует изменения существующих моделей
- ❌ Нужна миграция данных

---

## Вариант 2: Field Extensions (Расширения полей)
### Концепция: Расширение существующей модели динамическими полями

### Архитектура
Сохраняем текущую модель `ProjectTask`, добавляем:
```go
type TaskFieldExtension struct {
    ID          uint    `json:"id"`
    TaskID      uint    `json:"taskId"`
    FieldKey    string  `json:"fieldKey"`
    FieldValue  string  `json:"fieldValue"`  // JSON значение
    FieldType   string  `json:"fieldType"`
}
```

### UI Конструктора
Упрощенный вариант:
- Список предустановленных полей (все существующие поля ProjectTask)
- Возможность добавить кастомное поле
- Настройка видимости/обязательности

### Преимущества ✅
- ✅ Простая реализация
- ✅ Не требует больших изменений
- ✅ Обратная совместимость

### Недостатки ❌
- ❌ Ограниченная гибкость
- ❌ Сложность поиска по кастомным полям
- ❌ Дублирование данных

---

## Вариант 3: JSON Schema Builder
### Концепция: JSON Schema для определения структуры задач

### Архитектура
```go
type TaskDefinition struct {
    ID          uint    `json:"id"`
    Name        string  `json:"name"`
    Schema      string  `json:"schema"`  // JSON Schema
    UISchema    string  `json:"uiSchema"` // UI hints for rendering
}
```

Использование JSON Schema стандарта для валидации.

### Преимущества ✅
- ✅ Стандартный подход
- ✅ Много готовых библиотек для валидации
- ✅ Экспорт/импорт схем

### Недостатки ❌
- ❌ Менее интуитивный UI
- ❌ Требует знания JSON Schema
- ❌ Сложность для нетехнических пользователей

---

## 🎯 Рекомендация

**Рекомендую Вариант 1: Template-based**

### Почему?
1. **Баланс гибкости и простоты** - достаточно мощный, но не overengineered
2. **Интуитивный UI** - Drag & Drop, визуальный редактор
3. **Масштабируемость** - легко добавлять новые типы полей
4. **Переиспользование** - шаблоны можно копировать и модифицировать

### Этапы реализации

#### Фаза 1: Минимальная версия (MVP) - 1 неделя
- ✅ Базовая модель TaskTemplate и TaskFieldTemplate
- ✅ CRUD API для шаблонов
- ✅ Простая форма создания шаблона (без Drag & Drop)
- ✅ 5 базовых типов полей: text, number, date, select, checkbox

#### Фаза 2: Улучшенный UI - 1 неделя
- ✅ Drag & Drop интерфейс
- ✅ Секции и группировка полей
- ✅ Предпросмотр шаблона
- ✅ Копирование шаблонов

#### Фаза 3: Расширенные возможности - 1 неделя
- ✅ Условная видимость полей
- ✅ Вычисляемые поля
- ✅ Версионирование шаблонов
- ✅ Импорт/экспорт шаблонов

---

## 📐 Дизайн UI (для Варианта 1)

### Навигация
```
Администрирование
├── Управление ролями
├── Настройки workflow
└── 🆕 Конструктор задач  ← НОВЫЙ
```

### Список шаблонов
```
┌────────────────────────────────────────────────────┐
│ Конструктор задач                  [+ Создать]      │
├────────────────────────────────────────────────────┤
│                                                     │
│  Поиск: [______________]  Категория: [Все ▼]       │
│                                                     │
│  ┌─────────────────────────────────────────────┐  │
│  │ 📋 Аудит магазина                           │  │
│  │ Категория: Аудит • 12 полей • Активен       │  │
│  │ [✏️ Редактировать] [📋 Копировать] [🗑️ Удалить]│  │
│  └─────────────────────────────────────────────┘  │
│                                                     │
│  ┌─────────────────────────────────────────────┐  │
│  │ 💰 Утверждение бюджета                       │  │
│  │ Категория: Бюджет • 8 полей • Активен       │  │
│  │ [✏️ Редактировать] [📋 Копировать] [🗑️ Удалить]│  │
│  └─────────────────────────────────────────────┘  │
│                                                     │
└────────────────────────────────────────────────────┘
```

### Редактор шаблона (3-колоночный layout)
```
┌─────────┬─────────────────────────────┬──────────┐
│Компоненты│     Холст редактора         │Свойства │
│         │                             │         │
│📝 Текст  │  Секция: Основное          │Название:│
│🔢 Число  │  ┌──────────────────┐      │[______]│
│📅 Дата   │  │📝 Название * req │      │        │
│🔽 Список │  └──────────────────┘      │Тип:    │
│☑️ Чекбокс │  ┌──────────────────┐      │[📝 Текст▼]│
│📎 Файл   │  │👤 Ответственный *│      │        │
│👤 Юзер   │  └──────────────────┘      │☑ Обязат│
│💰 Деньги │                             │☐ ReadOnly│
│         │  Секция: Бюджет            │        │
│[+ Секция]│  ┌──────────────────┐      │[🗑️] [✓] │
│         │  │💰 Сумма без НДС  │ ←selected     │
│         │  └──────────────────┘      │        │
│         │                             │        │
│         │  [+ Добавить поле]          │        │
└─────────┴─────────────────────────────┴──────────┘
          [Отменить]  [Предпросмотр]  [Сохранить]
```

---

## 🔧 Технический стек

### Frontend
- **React** - основной framework
- **react-beautiful-dnd** - Drag & Drop
- **react-hook-form** - управление формами
- **zod** - валидация схем
- **@dnd-kit/core** - альтернатива для DnD (более современная)

### Backend  
- **Go** - существующий backend
- **GORM** - ORM для работы с шаблонами
- **JSON Schema** - валидация кастомных полей

---

## 📊 Оценка сложности

| Вариант | Сложность | Время разработки | Гибкость | UI качество |
|---------|-----------|------------------|----------|-------------|
| **Вариант 1: Template-based** | ⭐⭐⭐ | 3 недели | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ |
| Вариант 2: Field Extensions | ⭐⭐ | 1 неделя | ⭐⭐⭐ | ⭐⭐⭐ |
| Вариант 3: JSON Schema | ⭐⭐⭐⭐ | 2 недели | ⭐⭐⭐⭐ | ⭐⭐ |

---

## 🚀 Следующие шаги

Если выберете **Вариант 1 (Template-based)**:

1. **Утверждение дизайна** - review UI mockups
2. **Создание моделей** - TaskTemplate, TaskFieldTemplate
3. **Backend API** - CRUD для шаблонов
4. **Frontend MVP** - простая форма без DnD
5. **Drag & Drop** - визуальный редактор
6. **Интеграция** - использование при создании задач

**Начать с чего?**
1. Создать модели и миграции
2. Разработать API endpoints
3. Создать базовую страницу конструктора

Готов начать реализацию! С чего предпочитаете начать?
